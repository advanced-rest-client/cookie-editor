<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../cookie-editor.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <cookie-editor></cookie-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, sinon, MockInteractions */
    suite('Empty editor', function() {
      const name = 'test-name';
      const value = 'test-value';
      const domain = 'test-domain';
      const path = 'test-path';
      const exp = 1508510400000;

      const dummyEvent = new CustomEvent('test', {}, {
        cancelable: true
      });

      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Does not pass validation', function() {
        var validated = element.$.form.validate();
        assert.isFalse(validated);
      });

      test('Does not send save event', function() {
        var spy = sinon.spy();
        element.addEventListener('save-cookie', spy);
        element._save();
        assert.isFalse(spy.called);
      });

      test('Sends save event for minimum required', function() {
        var spy = sinon.spy();
        element.addEventListener('save-cookie', spy);
        var cookie = {
          name: name,
          domain: domain,
          path: path
        };
        element.cookie = cookie;
        element._save();
        assert.isTrue(spy.calledOnce);
      });

      test('Send event contains form properties', function() {
        var eventData;
        element.addEventListener('save-cookie', function clb(e) {
          element.removeEventListener('save-cookie', clb);
          eventData = e.detail;
        });
        var cookie = {
          name: name,
          domain: domain,
          path: path,
          value: value,
          expires: exp,
          hostOnly: true,
          httpOnly: true,
          secure: true,
          session: true
        };
        element.cookie = cookie;
        element._formSubmit(dummyEvent);
        assert.typeOf(eventData, 'object');
        assert.equal(eventData.name, name);
        assert.equal(eventData.domain, domain);
        assert.equal(eventData.value, value);
        assert.typeOf(eventData.expires, 'number');
        assert.isTrue(eventData.hostOnly);
        assert.isTrue(eventData.httpOnly);
        assert.isTrue(eventData.secure);
        assert.isTrue(eventData.session);
      });

      test('Cancel button fires cancel custom event', function() {
        var spy = sinon.spy();
        element.addEventListener('cancel-cookie-edit', spy);
        const button = element.$$('[data-action="cancel-action"]');
        MockInteractions.tap(button);
        assert.isTrue(spy.calledOnce);
      });

      test('Save button send save event', function() {
        var spy = sinon.spy();
        element.addEventListener('save-cookie', spy);
        var cookie = {
          name: name,
          domain: domain,
          path: path
        };
        element.cookie = cookie;
        const button = element.$$('[data-action="save-action"]');
        MockInteractions.tap(button);
        assert.isTrue(spy.calledOnce);
      });
    });

    suite('_convertTime()', function() {
      const pattern = /^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}$/;
      var element;
      setup(function() {
        element = fixture('basic');
      });

      test('Converts current time', function() {
        const result = element._convertTime(Date.now());
        assert.isTrue(pattern.test(result));
      });

      test('Has 0-pads', function() {
        var d = new Date();
        d.setDate(1);
        d.setMonth(1);
        d.setHours(1);
        d.setMinutes(1);
        const result = element._convertTime(d.getTime());
        assert.isTrue(pattern.test(result));
      });
    });
    </script>

  </body>
</html>
